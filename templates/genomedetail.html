{% extends 'admin/master.html' %}

{% block head_tail %}
{{ super() }}

<script src="../../static/js/d3/d3.min.js"></script>
<script src="../../static/js/d3/d3-tip.js"></script>
<script src="../../static/js/select.js"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.3.1.min.js') }}"></script>


<link href="{{ url_for('static', filename='css/select.css') }}" rel="stylesheet">

<link href="{{ url_for('static', filename='css/tracks.css') }}" rel="stylesheet">
{{ JSGlue.include() }}


{% endblock %}

{% block body %}

<div>

    Selected genome is {{genome_name}} <br>
    Selected page is {{page_name}}
    <br>
    <br>

     <form method="POST" enctype="multipart/form-data">
        {{ page_form.hidden_tag() }}

          <div class="smallform">

            {{ page_form.page.label }}

            {{ page_form.page }}

              <br>

              {{ page_form.select_page(class="btn-primary") }}


          </div>
     </form>

    <br>
    <br>






    <form method="POST" enctype="multipart/form-data">
        {{ select_form.hidden_tag() }}

        <div class="smallform">

            {{ select_form.genome.label }}

            {{ select_form.genome }}




            <br>


            {{ select_form.submit_diagram(class="btn-primary") }}
        </div>

        <br>
        {{select_form.hidden_hits}}


        {{select_form.hidden_hits.label (class_= "genome-search") }}

        <br>


        <br>

        {{select_form.show_hits.label }}

        <br>

        {{select_form.show_hits}}


        <br>
    </form>

</div>

<div>
    Currently selected genome is {{genome_name}}
</div>

<div>

    <form method="POST" enctype="multipart/form-data">
        {{ region_form.hidden_tag() }}

        <div class="region_form">
            <br>
            {{region_form.showA1}}
            {{region_form.showA1.label (class_= "genome-search") }}
            <br>
            {{region_form.showA2}}
            {{region_form.showA2.label (class_= "genome-search") }}
            <br>
            {{region_form.showTcdA1}}
            {{region_form.showTcdA1.label (class_= "genome-search") }}
            <br>
            {{region_form.showTcB}}
            {{region_form.showTcB.label (class_= "genome-search") }}
            <br>
            {{region_form.showTcC}}
            {{region_form.showTcC.label (class_= "genome-search") }}
            <br>
            {{region_form.showChitinase}}
            {{region_form.showChitinase.label (class_= "genome-search") }}
            <br>

            {{region_form.show_regions}}
        </div>
    </form>


</div>
<script>


    var tracks = {{tracks | safe }};


</script>
<div id="current_tags">

    Genome is currently tagged with -

    {{genome_tags | safe}}


</div>

<div id="hit_div">

    Tag to add <input id="tag2add" type="text" value="">
    <br>
    <br>

    <button name="tagBtn" class="btn-primary" id="tag_hit" type="submit">Add tag</button>

    <button name="tagBtn" class="btn-primary" id="hide_hit" type="submit">Hide hit</button>


    <button name="tagBtn" class="btn-primary" id="delete_hit" type="submit">Delete hit</button>
    <br>
    <br>

    <button name="tagBtn" class="btn-primary" id="tag_genome" type="submit">Tag genome</button>
    <button name="tagBtn" class="btn-primary" id="clear_genome_tags" type="submit">Clear all genome tags</button>

    <br>
    <br>
        <button name="tagBtn" class="btn-primary" id="associate_hits" type="submit">Associate A1 / A2 region </button>

    <br>
    <br>



    List of hits to tag, hide, or delete:
    <div id="myList">
    </div>

</div>


<br>
<br>
<div id="scrollable>">
    <div id="circularchart"></div>
    <div id="demo-controls">


    </div>
    <div id="linearchart"></div>
    <div id="brush"></div>

    <input type="button" id="resizeButton" onClick="resizeLinearPlot(); return false;" value="Resize plot">
</div>

<script>
    var genomesize = "{{genomesize | safe}}";
</script>
<!--<script type="text/javascript" src="../../static/js/data.simple.js"></script>-->
<script type="text/javascript" src="../../static/js/circularplot.js"></script>
<script type="text/javascript" src="../../static/js/linearplot.js"></script>
<script type="text/javascript" src="../../static/js/linearbrush.js"></script>
<script type="text/javascript" src="../../static/js/lineardemo.js"></script>
<script type="text/javascript" src="../../static/js/circularsample.js"></script>

{% if hidden_type == true %}
<script>
    $("#hidden_hits").prop('checked', true);

</script>

{% else %}
<script>
    $("#hidden_hits").prop('checked', false);

</script>

{% endif %}


<script>
    console.log("CHECKED REGIONS IS")
    console.log("{{checked_regions | safe}}")

    var r = {{checked_regions | safe}}

    for(var i=0;i<r.length;i++) {
//        console.log(r[i])
    $('#show' + r[i]).prop('checked', true)
    }

</script>

<script>

//    console.log('what is it here')
//    console.log("{{hit_type}}")
//    console.log("{{hidden_type}}")




    var genome = "{{ genome.id |safe }}"
    var genome_name = "{{ genome.name |safe }}"
    var genome_species = "{{ genome.species | safe}}"

    console.log('the id is')
    console.log(genome)




    $('#show_hits').val("{{hit_type | safe }}")

    $('#page').val("{{page_name | safe }}")
    $('#genome').val("{{genome.id | safe }}")

    function collect_details(){

        var checkedregions = [];
        $("input[name^='show']:checked").each(function() {
            checkedregions.push($(this).attr('name').split("show")[1].trim());
        });

        var genome = "{{ genome.id |safe }}"
        var show_hits = $('#show_hits').val()
        var hidden_hits = $('#hidden_hits').is(":checked")

        console.log('checers')
        console.log(checkedregions)

        return [genome, show_hits, hidden_hits, checkedregions]

    }

        function submit_details(){

        console.log('got to submit details')

        var details = collect_details()
        genome = details[0];
        show_hits =details[1];
        hidden_hits = details[2];
        checked_regions = details[3];

        $.ajax({

            type: "POST",
            contentType: "application/json;charset=utf-8",
            url: "{{  url_for ('show_hits')}}",
            data: JSON.stringify({
                'genome': genome, 'hits': show_hits, 'hidden_type': hidden_hits, 'checked_regions': checked_regions
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            traditional: "true",
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }


        });
    }





    $('#show_regions').on('click', function (e) {
                e.preventDefault();

        console.log('clicked show regions')
        submit_details()

    });





    $('#hidden_hits').on('change', function (e) {

//        e.preventDefault();
//        console.log('clicked hidden hits regions')
        submit_details()

    });

    $('#show_hits').on('change', function (e) {

        e.preventDefault();
        console.log('clicked show hits')
        submit_details()
    });


    $('#submit_hit').on('click', function (e) {
        e.preventDefault();
        console.log('clicked submit hit');
        submit_details()


    });

    $('#tag_genome').on('click', function (e) {

//        var genome = "{{ genome.id |safe }}";
//        var genome_name = "{{ genome_name |safe }}";

        tag2add = $("#tag2add").val();


        $.ajax({
            url: Flask.url_for("tag_genome"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name, 'genome_species' : genome_species, 'tag2add': tag2add
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }
        });

    });

        $('#clear_genome_tags').on('click', function (e) {

//        var genome = "{{ genome.id |safe }}";
//        var genome_name = "{{ genome.name |safe }}";

            console.log ('gneom and genome name and species are')
            console.log(genome)
            console.log(genome_name)
            console.log(genome_species)



        $.ajax({
            url: Flask.url_for("clear_genome_tags"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name,'genome_species' : genome_species,
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {


                window.location.reload();


            }
        });

    });

    $('#hide_hit').on('click', function (e) {
//        e.preventDefault();
//        console.log('clicked hide hit')

//        var genome = "{{ genome.id |safe }}"
//        var genome_name = "{{ genome.name |safe }}";

        tag2add = 'hidden';


        $.ajax({
            url: Flask.url_for("tag_hit"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name,'genome_species' : genome_species, 'hits': selected, 'tag2add': tag2add
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }
        });

    });


    $('#tag_hit').on('click', function (e) {
//        e.preventDefault();
//        console.log('clicked tag hit')

//        var genome = "{{ genome.id |safe }}"
//        var genome_name = "{{ genome.name |safe }}";

        tag2add = $("#tag2add").val();


        $.ajax({
            url: Flask.url_for("tag_hit"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name,'genome_species' : genome_species, 'hits': selected, 'tag2add': tag2add
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }
        });

    });

    $('#delete_hit').on('click', function (e) {
//        e.preventDefault();
//        console.log('clicked delete hit')

//        var genome = "{{ genome.id |safe }}"
//        var genome_name = "{{ genome.name |safe }}";



        $.ajax({
            url: Flask.url_for("delete_hit"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name,'genome_species' : genome_species, 'hits': selected
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }
        });

    });

        $('#associate_hits').on('click', function (e) {
        console.log('clicked associate hits')

//        var genome = "{{ genome.id |safe }}";
//        var genome_name = "{{ genome.name |safe }}";


//        console.log(selected);
//
//        console.log ('length was')
//            console.log(Object.keys(selected).length)
//



        if (Object.keys(selected).length != 2) {
                        alert("Can only associate between 2 regions at a time")
        }

        else {

            console.log(selected[0])
        }



        $.ajax({
            url: Flask.url_for("associate_hits"),
            data: JSON.stringify({
                'genome': genome, 'genome_name' : genome_name, 'genome_species' : genome_species, 'hits': selected,
            }),
            contentType: 'application/json;charset=UTF-8',
            type: 'POST',
            error: function (error) {
                console.log(error);
            },
            success: function (response) {

                console.log('bamboozled')

                window.location.reload();


            }
        });

    });
</script>

{% endblock %}



